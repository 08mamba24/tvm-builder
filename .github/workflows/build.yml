name: Build Apache TVM Multi-ARM-Target

on:
  push:
    branches: 'main'
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
    steps:
      - uses: actions/github-script@v7
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'heads/main',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));

  # 任务一：Manylinux 多版本构建 (aarch64 容器)
  build_manylinux:
    needs: [meta]
    runs-on: ubuntu-22.04-arm
    strategy:
      fail-fast: false
      matrix:
        # 2_28 保证旧版 openEuler/CentOS 兼容性
        # 2_34 完美匹配你当前的 openEuler 2.34 系统
        manylinux: [manylinux_2_28, manylinux_2_34]
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - name: Build wheels via cibuildwheel
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS_LINUX: aarch64
          CIBW_BUILD: cp311-*
          CIBW_MANYLINUX_AARCH64_IMAGE: ${{ matrix.manylinux }}
          CIBW_BEFORE_ALL_LINUX: >
            yum install -y llvm-devel libedit-devel libxml2-devel zlib-devel ncurses-devel cmake ninja-build ||
            dnf install -y llvm-devel libedit-devel libxml2-devel zlib-devel ncurses-devel cmake ninja-build
          CIBW_BEFORE_BUILD_LINUX: >
            pip install numpy setuptools wheel cython &&
            cd 3rdparty/tvm-ffi/ && mkdir -p build && cd build &&
            cmake .. -DCMAKE_BUILD_TYPE=Release && make -j$(nproc) &&
            cp libtvm_ffi.so /usr/lib64/ && ldconfig
          CIBW_ENVIRONMENT: >
            TVM_CMAKE_ARGS="-G Ninja -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM=ON -DUSE_CUDA=OFF"
            LD_LIBRARY_PATH="/usr/lib64:$LD_LIBRARY_PATH"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.manylinux }}-aarch64
          path: ./wheelhouse/*.whl

  # 任务二：AMD64 交叉编译 AARCH64 (速度极快)
  cross_compile_arm:
    needs: [meta]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - name: Install Cross-compilation Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu cmake ninja-build llvm-dev
          
      - name: Build TVM (Cross)
        run: |
          mkdir build && cd build
          # 使用交叉编译工具链定义
          echo "set(CMAKE_SYSTEM_NAME Linux)" > toolchain.cmake
          echo "set(CMAKE_SYSTEM_PROCESSOR aarch64)" >> toolchain.cmake
          echo "set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)" >> toolchain.cmake
          echo "set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)" >> toolchain.cmake
          
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_LLVM=OFF \
            -DUSE_RPC=ON
          ninja

  # 任务三：统一 Release
  release:
    needs: [meta, build_manylinux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: upload
          merge-multiple: true

      - uses: softprops/action-gh-release@v2.3.3
        with:
          name: Apache TVM Multi-Compatible ARM Build
          tag_name: nightly-${{ github.run_id }}
          body: |
            ### ARM64 Wheels:
            - **Manylinux 2.28**: 最高兼容性版 (Glibc 2.28+)
            - **Manylinux 2.34**: 性能优化版 (Glibc 2.34+, 完美适配 openEuler)
          files: upload/*.whl
          prerelease: true
