name: Build TVM ManyLinux ARM Wheels

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # 核心：使用 glibc 2.24 的 manylinux 镜像以满足兼容性要求
  MANYLINUX_IMAGE: "quay.io/pypa/manylinux_2_24_aarch64"

jobs:
  # 主构建任务：在 manylinux 2.24 容器中为 ARM 架构构建 wheel
  build_manylinux_aarch64:
    runs-on: ubuntu-22.04-arm
    container:
      # 所有步骤将在指定的 manylinux 容器内执行，确保环境纯净
      image: ${{ env.MANYLINUX_IMAGE }}
    steps:
      - name: Checkout TVM Code
        uses: actions/checkout@v4
        with:
          repository: apache/tvm
          ref: main
          submodules: recursive

      - name: Install System Dependencies in Container
        run: |
          # 安装构建 TVM 所需的所有核心开发工具和库
          yum install -y gcc gcc-c++ cmake ninja-build \
            llvm-devel libedit-devel libxml2-devel \
            zlib-devel ncurses-devel
          # 验证编译器
          which gcc g++ cmake llvm-config

      - name: Build Wheels with cibuildwheel
        run: |
          # 升级 pip 并安装构建依赖
          pip install -U pip cibuildwheel==2.22.0 numpy setuptools wheel cython
          # 使用 cibuildwheel 执行构建，它会自动处理项目编译和打包
          cibuildwheel --output-dir ./wheelhouse --platform linux .
        env:
          # 配置 cibuildwheel 仅构建 ARM 64位 manylinux 2.24 的包
          CIBW_ARCHS: aarch64
          CIBW_BUILD: cp311-manylinux_aarch64
          CIBW_MANYLINUX_AARCH64_IMAGE: ${{ env.MANYLINUX_IMAGE }}
          # 传递给 TVM CMake 构建系统的关键参数
          # 重点：明确指定 LLVM 配置工具的路径，这是成功的关键
          CIBW_ENVIRONMENT: "TVM_CMAKE_ARGS='-G Ninja -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM=/usr/bin/llvm-config -DUSE_CUDA=OFF'"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tvm-wheels-manylinux_2_24_aarch64
          path: ./wheelhouse/*.whl

  # 可选：发布任务，将构建成功的 wheels 创建为 GitHub Release
  create-release:
    needs: [build_manylinux_aarch64]
    # 仅在主分支的构建成功时运行
    if: github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Wheel Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-wheels
          merge-multiple: true

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          name: "TVM Nightly Build (manylinux_2_24_aarch64)"
          tag_name: nightly-${{ github.sha }}
          body: |
            Automated nightly build of Apache TVM for **ARM64 (aarch64)**.
            **Platform:** manylinux_2_24 (glibc >= 2.24)
            **Build SHA:** ${{ github.sha }}
            **Date:** ${{ fromJSON('["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]')[github.event.head_commit.timestamp[5:7]-1] }} ${{ github.event.head_commit.timestamp[8:10] }}, ${{ github.event.head_commit.timestamp[0:4] }}
          files: |
            ./all-wheels/**/*.whl
          draft: false
          prerelease: true
