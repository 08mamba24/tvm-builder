name: Build Apache TVM Cross-Compile ARM

on:
  push:
    branches: 'main'
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
    steps:
      - uses: actions/github-script@v7
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'heads/main',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));

  cross_compile_arm:
    needs: [meta]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - name: Install Cross-compilation Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu cmake ninja-build python3-dev python3-pip

      - name: Build TVM (Cross-Compile)
        run: |
          mkdir build && cd build
          # 配置交叉编译工具链
          cat <<EOF > toolchain.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          EOF
          
          # 交叉编译核心库 (关闭 LLVM 以适配通用 GLIBC)
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_LLVM=OFF \
            -DUSE_RPC=ON \
            -DUSE_CPP_RPC=ON
          ninja

      - name: Package Wheel
        run: |
          # 确保在项目根目录下操作
          echo "Current Path: $(pwd)"
          
          # 关键步骤：创建内部 lib 目录并将编译出的 so 放入其中
          mkdir -p python/tvm/lib
          if [ -f "build/libtvm.so" ]; then
            cp build/libtvm.so python/tvm/lib/
            echo "Successfully copied libtvm.so to python/tvm/lib/"
          else
            echo "Error: build/libtvm.so not found!" && exit 1
          fi
          
          # 拷贝 runtime 库（如果存在）
          cp build/libtvm_runtime.so python/tvm/lib/ || true

          # 进入 python 目录打包
          cd python
          pip install wheel setuptools
          # --plat-name 标记为 ARM 架构以绕过环境检查
          python3 setup.py bdist_wheel --plat-name manylinux2014_aarch64

      - uses: actions/upload-artifact@v4
        with:
          name: tvm-cross-compiled-wheel
          path: python/dist/*.whl

  release:
    needs: [meta, cross_compile_arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: upload
          merge-multiple: true

      - uses: softprops/action-gh-release@v2.3.3
        with:
          name: Apache TVM ARM64 Cross-Build (${{ needs.meta.outputs.SHORT_SHA }})
          tag_name: cross-nightly-${{ github.run_id }}
          body: |
            ### 产物信息
            - **架构**: ARM64 (aarch64)
            - **编译环境**: Cross-compiled from Ubuntu 24.04
            - **GLIBC 兼容性**: 理论支持 2.30+ (适配 openEuler 2.34)
            - **包含组件**: TVM Runtime, RPC Server, Python Bindings (No LLVM)
          files: upload/*.whl
          prerelease: true
