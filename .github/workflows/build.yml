name: Build Apache TVM & FFI Cross-Compile ARM

on:
  push:
    branches: 'main'
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
    steps:
      - uses: actions/github-script@v7
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'heads/main',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));

  cross_compile_arm:
    needs: [meta]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive
          path: tvm_src

      - name: Install Cross-compilation Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu cmake ninja-build python3-dev python3-venv

      - name: Build TVM & FFI (Cross-Compile)
        run: |
          ROOT_DIR="${{ github.workspace }}/tvm_src"
          cat <<EOF > ${{ github.workspace }}/toolchain.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          EOF

          mkdir -p "$ROOT_DIR/build" && cd "$ROOT_DIR/build"
          cmake .. -G Ninja -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM=OFF -DUSE_RPC=ON
          ninja

          FFI_DIR="$ROOT_DIR/3rdparty/tvm-ffi"
          if [ -d "$FFI_DIR" ]; then
            mkdir -p "$FFI_DIR/build" && cd "$FFI_DIR/build"
            cmake .. -G Ninja -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/toolchain.cmake -DCMAKE_BUILD_TYPE=Release
            ninja
          fi

      - name: Package Wheels (TVM & FFI)
        run: |
          set -e
          ROOT_DIR="${{ github.workspace }}/tvm_src"
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel build numpy cython

          mkdir -p "$ROOT_DIR/dist_final"

          # 封装重命名逻辑函数，增强鲁棒性
          rename_wheel() {
            for f in *.whl; do
              if [[ "$f" == *"x86_64"* ]]; then
                mv "$f" "$(echo $f | sed 's/x86_64/aarch64/g' | sed 's/linux/manylinux2014/g')"
              elif [[ "$f" == *"any.whl" ]]; then
                mv "$f" "$(echo $f | sed 's/py3-none-any.whl/py3-none-manylinux2014_aarch64.whl/g')"
              fi
            done
          }

          # 打包 TVM
          cd "$ROOT_DIR/python"
          mkdir -p tvm/lib && cp "$ROOT_DIR/build/libtvm.so" tvm/lib/
          python3 -m build --wheel
          cd dist && rename_wheel && cp *.whl "$ROOT_DIR/dist_final/"

          # 打包 FFI
          FFI_PY_DIR="$ROOT_DIR/3rdparty/tvm-ffi/python"
          if [ -d "$FFI_PY_DIR" ]; then
            cd "$FFI_PY_DIR"
            mkdir -p tvm_ffi/lib && cp "$ROOT_DIR/3rdparty/tvm-ffi/build/libtvm_ffi.so" tvm_ffi/lib/
            python3 -m build --wheel
            cd dist && rename_wheel && cp *.whl "$ROOT_DIR/dist_final/"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: tvm-full-arm-wheels
          path: tvm_src/dist_final/*.whl

  release:
    needs: [meta, cross_compile_arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: upload
          merge-multiple: true

      - uses: softprops/action-gh-release@v2.3.3
        with:
          name: Apache TVM Full ARM64 Build
          tag_name: cross-nightly-${{ github.run_id }}
          files: upload/*.whl
          prerelease: true
