name: Build Apache TVM Cross-Compile ARM

on:
  push:
    branches: 'main'
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
    steps:
      - uses: actions/github-script@v7
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'heads/main',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));

  cross_compile_arm:
    needs: [meta]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive
          path: tvm_src

      - name: Install Cross-compilation Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu cmake ninja-build python3-dev python3-venv

      - name: Build TVM (Cross-Compile)
        run: |
          ROOT_DIR="${{ github.workspace }}/tvm_src"
          BUILD_DIR="$ROOT_DIR/build"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          
          cat <<EOF > toolchain.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          EOF
          
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_LLVM=OFF \
            -DUSE_RPC=ON \
            -DUSE_CPP_RPC=ON
          ninja

      - name: Package Wheel (Modern PEP517 Logic)
        run: |
          set -e
          ROOT_DIR="${{ github.workspace }}/tvm_src"
          PYTHON_DIR="$ROOT_DIR/python"
          BUILD_DIR="$ROOT_DIR/build"
          
          # 1. 注入二进制产物
          mkdir -p "$PYTHON_DIR/tvm/lib"
          cp "$BUILD_DIR/libtvm.so" "$PYTHON_DIR/tvm/lib/"
          cp "$BUILD_DIR/libtvm_runtime.so" "$PYTHON_DIR/tvm/lib/" || true
          
          # 2. 准备现代构建环境
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel build numpy cython
          
          # 3. 执行构建
          cd "$PYTHON_DIR"
          echo "Building wheel from $(pwd) using pyproject.toml"
          
          # 使用 python -m build 替代 setup.py
          # 环境变量设置：某些版本的 TVM 构建脚本会检查这个来决定是否打包 so
          export TVM_LIBRARY_PATH="$PYTHON_DIR/tvm/lib"
          python3 -m build --wheel
          
          # 4. 关键步骤：修正架构标记
          # 交叉编译产出的 wheel 默认会被标记为当前系统的 x86_64
          # 我们需要手动更名或在打包时指定，这里采用更名方式最稳妥
          cd dist
          ORIG_WHEEL=$(ls *.whl)
          # 将 linux_x86_64 替换为 manylinux2014_aarch64
          NEW_WHEEL=$(echo $ORIG_WHEEL | sed 's/linux_x86_64/manylinux2014_aarch64/g')
          if [ "$ORIG_WHEEL" != "$NEW_WHEEL" ]; then
            mv "$ORIG_WHEEL" "$NEW_WHEEL"
            echo "Renamed $ORIG_WHEEL to $NEW_WHEEL"
          fi
          
          # 5. 收集产物
          mkdir -p "$ROOT_DIR/dist_final"
          cp "$NEW_WHEEL" "$ROOT_DIR/dist_final/"

      - uses: actions/upload-artifact@v4
        with:
          name: tvm-cross-compiled-wheel
          path: tvm_src/dist_final/*.whl

  release:
    needs: [meta, cross_compile_arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: upload
          merge-multiple: true

      - uses: softprops/action-gh-release@v2.3.3
        with:
          name: Apache TVM ARM64 Cross-Build (${{ needs.meta.outputs.SHORT_SHA }})
          tag_name: cross-nightly-${{ github.run_id }}
          body: |
            ### 构建完成 (PEP517)
            - **Target**: aarch64
            - **Method**: Cross-compiled & build module
            - **Compatibility**: Manylinux 2014 AARCH64
          files: upload/*.whl
          prerelease: true
