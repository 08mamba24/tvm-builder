# Note: armv7 (32-bit ARM) is not supported by GitHub Actions hosted runners.
# GitHub Actions only provides arm64 (ARM64/AArch64) runners.
# To build armv7, you would need self-hosted ARM32 runners or cross-compilation.

name: Build Apache TVM

on:
  push:
    branches: 'main'
  schedule:
    - cron: "0 17 * * 1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
      DATE_JST:  ${{ steps.date.outputs.DATE_JST }}
      DATE_JST_COMPACT: ${{ steps.date.outputs.DATE_JST_COMPACT }}
    steps:
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'tags/v0.22.0',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));
      - id: date
        run: |
          echo "DATE_JST=$(TZ=Asia/Tokyo date +%F)" >> $GITHUB_OUTPUT
          echo "DATE_JST_COMPACT=$(TZ=Asia/Tokyo date +%Y%m%d)" >> $GITHUB_OUTPUT

  build:
    needs: [meta]
    strategy:
      fail-fast: false
      matrix:
        arch: ['x86_64', 'arm64']
        python-version: ['3.11']
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive
          github-server-url: https://github.com

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}

      - uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          activate-environment: "true"

      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ matrix.arch }}-py3.11-${{ hashFiles('**/pyproject.toml', '3rdparty/tvm-ffi/pyproject.toml', 'CMakeLists.txt') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.arch }}-py3.11-

      - uses: hendrikmuhs/ccache-action@5ebbd400eff9e74630f759d94ddd7b6c26299639 # v1.2.20
        with:
          key: ccache-${{ runner.os }}-${{ matrix.arch }}-py3.11-llvm18-${{ needs.meta.outputs.SHORT_SHA }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.arch }}-py3.11-llvm18-
          max-size: 5G

      - name: Configure ccache
        run: |
          echo "CCACHE_DIR=$HOME/.cache/ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt update && sudo apt install -y gcc libtinfo-dev zlib1g-dev \
            build-essential libedit-dev libxml2-dev llvm-18-dev llvm-18-tools clang-18 libpolly-18-dev
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          uv pip install -U pip numpy cmake ninja wheel cython build setuptools pytest

      - name: Build zstd (PIC static)
        run: |
          set -euxo pipefail
          git clone --depth 1 https://github.com/facebook/zstd.git
          make -C zstd clean
          make -C zstd ZSTD_LEGACY_SUPPORT=0 CFLAGS="-O2 -fPIC"
          sudo make -C zstd install PREFIX=/usr/local
          echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/zz-local.conf
          sudo ldconfig
          rm -rf zstd

      - name: Define CMake args
        run: |
          echo "TVM_CMAKE_ARGS=\"-G Ninja; -DCMAKE_BUILD_TYPE=RelWithDebInfo; -DUSE_LLVM='llvm-config-18 --link-static'; -DUSE_MLIR=ON\"" >> $GITHUB_ENV
      - name: Build python package
        run: |
          uv build --wheel . --config-settings=cmake.args=${{ env.TVM_CMAKE_ARGS }}
          uv build --wheel 3rdparty/tvm-ffi/

      - name: Test TVM
        env:
          TVM_TEST_TARGETS: "llvm"
        run: |
          source .venv/bin/activate
          ABS_TESTS="$PWD/tests/python/all-platform-minimal-test"
          uv pip install 3rdparty/tvm-ffi/dist/apache_tvm_ffi-*.whl dist/tvm-*.whl
          cd ..; mkdir tmp; cd tmp;
          uv run python -c "import tvm; print(tvm.__file__); print(tvm.__version__); print(tvm.support.describe()); print(tvm.support.libinfo())"
          uv run pytest -v "$ABS_TESTS"

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-${{ runner.os }}-${{ matrix.arch }}-py3.11
          path: |
            dist/tvm-*.whl
            3rdparty/tvm-ffi/dist/apache_tvm_ffi-*.whl

  build-openeuler-arm64:
    needs: [meta]
    runs-on: ubuntu-24.04-arm
    container:
      image: openeuler/openeuler:22.03-lts-sp4
    env:
      TVM_CMAKE_ARGS: "-G Ninja; -DCMAKE_BUILD_TYPE=RelWithDebInfo; -DUSE_LLVM='llvm-config-18 --link-static'; -DUSE_MLIR=ON"
    steps:
      - name: Upgrade Git for submodule support
        run: |
          yum update -y git || yum install -y git
          git --version

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive
          github-server-url: https://github.com

      - name: Check GLIBC version
        run: |
          echo "========================================"
          echo "GLIBC Version:"
          ldd --version | head -1
          echo "========================================"

      - name: Install dependencies (openEuler)
        run: |
          yum update -y
          yum install -y python3 python3-pip python3-devel
          yum install -y gcc gcc-c++ make
          yum install -y cmake ninja-build
          yum install -y git
          yum install -y libxml2-devel zlib-devel ncurses-devel

      - name: Install LLVM
        run: |
          yum install -y llvm18-devel llvm18-tools clang18 || \
          yum install -y llvm-devel llvm-tools clang || \
          echo "WARNING: LLVM 18 not available, falling back to system LLVM"

      - name: Build zstd (PIC static)
        run: |
          set -euxo pipefail
          git clone --depth 1 https://github.com/facebook/zstd.git
          make -C zstd clean
          make -C zstd ZSTD_LEGACY_SUPPORT=0 CFLAGS="-O2 -fPIC"
          make -C zstd install PREFIX=/usr/local
          echo "/usr/local/lib" > /etc/ld.so.conf.d/zz-local.conf
          ldconfig
          rm -rf zstd

      - name: Install Python build tools
        run: |
          python3 -m pip install -U pip build numpy cython pytest wheel

      - name: Build python packages
        run: |
          python3 -m build --wheel . --config-settings=cmake.args="${TVM_CMAKE_ARGS}"
          python3 -m build --wheel 3rdparty/tvm-ffi/

      - name: Repair wheels with auditwheel
        run: |
          python3 -m pip install auditwheel
          mkdir -p wheelhouse
          auditwheel repair --plat manylinux_2_34_aarch64 -w wheelhouse dist/tvm-*.whl
          auditwheel repair --plat manylinux_2_34_aarch64 -w wheelhouse 3rdparty/tvm-ffi/dist/apache_tvm_ffi-*.whl
          ls -lh wheelhouse/

      - name: Test TVM
        env:
          TVM_TEST_TARGETS: "llvm"
        run: |
          python3 -m pip install wheelhouse/*.whl
          python3 -c "import tvm; print(tvm.__version__); print(tvm.support.describe())"
          ABS_TESTS="$PWD/tests/python/all-platform-minimal-test"
          cd ..; mkdir tmp; cd tmp;
          python3 -m pytest -v "$ABS_TESTS"

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-openeuler-arm64-py3.11
          path: wheelhouse/*.whl

  release:
    needs: [meta, build, build-openeuler-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: upload
          merge-multiple: true

      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: Apache TVM Weekly (${{ needs.meta.outputs.DATE_JST }}) [v0.22.0] [${{ needs.meta.outputs.SHORT_SHA }}]
          tag_name: weekly-${{ needs.meta.outputs.DATE_JST_COMPACT }}-v0.22.0-${{ needs.meta.outputs.SHORT_SHA }}
          body: |
            tvm: ${{ needs.meta.outputs.HASH }}
            Version: v0.22.0
            Architectures: x86_64, arm64 (Ubuntu), arm64 (openEuler 22.03)
            Python: 3.11
            Features: CPU-only (LLVM + MLIR)
            Built (JST): ${{ needs.meta.outputs.DATE_JST }}
          files: |
            upload/dist/*.whl
            upload/3rdparty/tvm-ffi/dist/*.whl
            upload/wheelhouse/*.whl
          prerelease: true
          fail_on_unmatched_files: true

      - name: Delete weekly tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete weekly --cleanup-tag --yes || true

      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: Apache TVM Weekly (latest)
          tag_name: weekly
          body: |
            tvm: ${{ needs.meta.outputs.HASH }}
            Version: v0.22.0
            Architectures: x86_64, arm64 (Ubuntu), arm64 (openEuler 22.03)
            Python: 3.11
            Features: CPU-only (LLVM + MLIR)
            Latest build (JST): ${{ needs.meta.outputs.DATE_JST }}
          files: |
            upload/dist/*.whl
            upload/3rdparty/tvm-ffi/dist/*.whl
            upload/wheelhouse/*.whl
          prerelease: true
          fail_on_unmatched_files: true
