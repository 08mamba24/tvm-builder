name: Build TVM ARM64 Multi-Environment

on:
  push:
    branches: 'main'
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    outputs:
      HASH: ${{ steps.tvm.outputs.HASH }}
      SHORT_SHA: ${{ steps.tvm.outputs.SHORT_SHA }}
    steps:
      - uses: actions/github-script@v7
        id: tvm
        with:
          script: |
            const { data } = await github.rest.git.getRef({
              owner: 'apache',
              repo: 'tvm',
              ref: 'heads/main',
            });
            core.setOutput('HASH', data.object.sha);
            core.setOutput('SHORT_SHA', data.object.sha.substring(0,8));

  # 1. Manylinux 容器构建 (解决你目前的 openEuler 报错)
  build_manylinux_228:
    needs: [meta]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - name: Build via cibuildwheel
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_ARCHS_LINUX: aarch64
          CIBW_BUILD: cp311-manylinux_aarch64
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          CIBW_BEFORE_ALL_LINUX: >
            yum install -y libedit-devel libxml2-devel zlib-devel ncurses-devel &&
            curl -L https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.8/clang+llvm-18.1.8-aarch64-linux-gnu.tar.xz | tar xJ -C /usr/local --strip-components=1
          CIBW_ENVIRONMENT: >
            TVM_CMAKE_ARGS="-G Ninja -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM='/usr/local/bin/llvm-config --link-static' -DUSE_CUDA=OFF"
          CIBW_BEFORE_BUILD: pip install numpy setuptools wheel cython

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-manylinux-228
          path: ./wheelhouse/*.whl

  # 2. Ubuntu 22.04 宿主机构建 (Glibc 2.35)
  build_ubuntu_2204:
    needs: [meta]
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt install -y gcc g++ cmake ninja-build libedit-dev libxml2-dev llvm-15-dev
          pip install numpy setuptools wheel cython build

      - name: Build
        run: |
          export TVM_CMAKE_ARGS="-G Ninja -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM='llvm-config-15 --link-static' -DUSE_CUDA=OFF"
          python3 -m build --wheel . --config-settings=cmake.args="$TVM_CMAKE_ARGS"
          cd 3rdparty/tvm-ffi/ && python3 -m build --wheel .

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-ubuntu-2204
          path: |
            dist/*.whl
            3rdparty/tvm-ffi/dist/*.whl

  # 3. Ubuntu 24.04 宿主机构建 (Glibc 2.39 - 面向未来架构)
  build_ubuntu_2404:
    needs: [meta]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'apache/tvm'
          ref: ${{ needs.meta.outputs.HASH }}
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt install -y gcc g++ cmake ninja-build libedit-dev libxml2-dev llvm-18-dev
          pip install numpy setuptools wheel cython build

      - name: Build
        run: |
          # 注意：针对 Ubuntu 24.04 的 GCC 13/14 警告，添加关闭参数防止编译中断
          export TVM_CMAKE_ARGS="-G Ninja -DCMAKE_BUILD_TYPE=Release -DUSE_LLVM='llvm-config-18 --link-static' -DUSE_CUDA=OFF -DCMAKE_CXX_FLAGS='-Wno-maybe-uninitialized -Wno-array-bounds'"
          python3 -m build --wheel . --config-settings=cmake.args="$TVM_CMAKE_ARGS"
          cd 3rdparty/tvm-ffi/ && python3 -m build --wheel .

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-ubuntu-2404-future
          path: |
            dist/*.whl
            3rdparty/tvm-ffi/dist/*.whl

  release:
    needs: [meta, build_manylinux_228, build_ubuntu_2204, build_ubuntu_2404]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - uses: softprops/action-gh-release@v2
        with:
          name: TVM ARM64 Multi-Arch Release [${{ needs.meta.outputs.SHORT_SHA }}]
          tag_name: nightly-arm64-${{ github.run_number }}
          body: |
            - **Manylinux 2.28**: Best compatibility (openEuler 20.03/22.03)
            - **Ubuntu 22.04**: Glibc 2.35
            - **Ubuntu 24.04**: Glibc 2.39 (Next-gen / Future proof)
          files: dist/*.whl
          prerelease: true
